# 服务端总体设计

## 初稿：多线程设计

服务端要干的事情

- 用户突发请求——消息队列

- 从等待区取出车插入，有空插入

- 充电桩计时还是总体计时——时间段计费，

  ```java
  //每个chargeStation有一个当前每秒计费，一到一个时间点更换这个每秒计费
  ```

  

发起一次充电请求后，服务器就存着这个car，直到充电完成或取消充电





充电区：一个线程

- 循环
  - 遍历所有充电桩的第一个充电（没有就不计费），完成一次计费和充电，要改动的存在car里。并且每个充电桩自己的剩余充电时间也要改
  - 处理要增加删除的list的car，注意只是把car加入或移出队列，没有删除car或新建car。当处理完后，记得修改car的状态，可以加个锁



等待区：一个线程

- 循环
  - 两个队列头遍历所有充电桩的剩余充电时间，选最小的，给充电桩的发个消息。可以加个锁，充电区有空闲的时候就会开锁
  - 处理要增删的等待的car



处理突发：一个或多个线程

- 处理消息队列，增删改查，涉及充电区的就给充电区发个消息就行
- 如果不用消息队列，那就控制器之前接管，那控制器会出现多个线程或协程吗



## 新版：服务端使用单线程加消息队列

- [ ] ```java
  消息队列，叫做MQ;
  public void run() {
      while(MQ is Not Empty) {
          Message msg = MQ.getHead;
          switch msg:
          case1:;
          schedule/charging
          case2：;
          case3;
          default:         
      }
  }
  ```



### 消息种类

- 提交



















# 废案

## 从起点终点得到总计费

```
while(对于所有时间段)
	if( !( 充电终点<时间段终点 || 充电起点>时间段终点 ) )
		总价 += 单位计费*( max{时间段终点，充电终点} - min{时间段起点,充电起点} );
```

